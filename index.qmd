---
title: "Travaux Pratiques `rcontroll`"
subtitle: "Une interface R pour le simulateur de dynamique foresti√®re bas√© sur les individus TROLL"
author: "Sylvain Schmitt"
institute: CIRAD
date: 2025/10/28
date-format: medium
format: 
  revealjs:
    theme: dark
    output-location: fragment
    slide-number: true
    logo: figs/logo_ucl.png
    transition: fade
    preview-links: true
    chalkboard: true
bibliography: references.bib
include-in-header:
  - text: |
      <style>
      .reveal .slide-logo {
        max-height: unset;
        height: 100px;
      }
      </style>
---

```{r set}
#| include: false
library(dplyr)
library(tidyr)
library(ggplot2)
library(rcontroll)
knitr::opts_chunk$set(echo = TRUE)
set.seed(42)
```

# Introduction

Nous allons aujourd'hui explorer l'utilisation de simulateurs forestiers en √©cologie, notamment √† travers un mod√®le bas√© sur les agents :

> mod√®le permettant de simuler les actions et les interactions d'agents autonomes afin de comprendre le comportement d'un syst√®me et les facteurs qui d√©terminent ses r√©sultats.

## Le jeu de la vie (J. Conway, 1970) {.smaller}

-   Chaque cellule ne peut se trouver que dans deux √©tats : allum√©e (vivante) ou √©teinte (morte)
-   Une cellule allum√©e le reste uniquement si 2 ou 3 de ses 8 voisines sont allum√©es
-   Une cellule √©teinte s‚Äôallume uniquement si 3 de ses 8 voisines sont allum√©es

```{r}
#| echo: false
knitr::include_graphics("https://user-images.githubusercontent.com/9169414/36646548-4ac65af8-1a79-11e8-811d-da84549f7af3.gif")
```

## Boids (C. W. Reynolds, 1986) {.smaller}

-   La coh√©sion : les boids se rapprochent les uns des autres
-   La s√©paration : deux boids ne peuvent pas se trouver au m√™me endroit au m√™me moment
-   L‚Äôalignement : les boids suivent leurs voisins

```{r}
#| echo: false
knitr::include_graphics("https://gameidea.org/wp-content/uploads/2024/03/2D-boids-simulation.gif")
```

## @levi2018 {.smaller}

> *Tropical forests can maintain hyperdiversity because of enemies*

::::: columns
::: column
```{r}
#| echo: false
knitr::include_graphics("https://upload.wikimedia.org/wikipedia/commons/9/9d/Adaptation_du_mod%C3%A8le_de_l%27effet_Janzen-Connell_%281970%29.png")
```
:::

::: column
```{r}
#| echo: false
knitr::include_graphics("https://www.pnas.org/cms/10.1073/pnas.1813211116/asset/7a01f42c-5dc2-44fc-a6ed-43658e9d145b/assets/graphic/pnas.1813211116fig01.jpeg")
```
:::
:::::

## @levi2018 {.smaller}

> *Tropical forests can maintain hyperdiversity because of enemies* par @levi2018

::::: columns
::: column
```{r}
#| echo: false
knitr::include_graphics("https://www.pnas.org/cms/10.1073/pnas.1813211116/asset/69fe93cd-bdb3-4bb9-b666-b42834acabf9/assets/graphic/pnas.1813211116fig02.jpeg")
```
:::

::: column
```{r}
#| echo: false
knitr::include_graphics("https://www.pnas.org/cms/10.1073/pnas.1813211116/asset/7a01f42c-5dc2-44fc-a6ed-43658e9d145b/assets/graphic/pnas.1813211116fig01.jpeg")
```
:::
:::::

# TROLL

> An Individual-BasedForest Model to Jointly Simulate Carbon and Tree Diversity in Amazonia par @Marechaux2017

## Qu'est-ce que c'est ?

TROLL mod√©lise chaque arbre individuellement dans un environnement spatialis√©. Le mod√®le TROLL peut donc √™tre d√©fini comme un mod√®le de croissance foresti√®re individuel, centr√© et spatialement explicite. Il simule le cycle de vie des arbres, depuis le recrutement √† partir d'un diam√®tre √† hauteur de poitrine (dbh) de 1 cm, jusqu'√† la mort. Les arbres poussent dans un environnement lumineux dont les valeurs sont calcul√©es dans des voxels de $1 m^3$.

## Repr√©sentation

```{r }
#| echo: false
knitr::include_graphics("https://gmd.copernicus.org/articles/18/5143/2025/gmd-18-5143-2025-avatar-web.png")
```

## Repr√©sentation

```{r }
#| echo: false
knitr::include_graphics("https://besjournals.onlinelibrary.wiley.com/cms/asset/c6ab93b7-9b2b-49f2-a1cd-abbb6de35318/mee314215-fig-0001-m.jpg")
```

## Fonctionnement {.smaller}

Chaque arbre est d√©fini par son √¢ge, son diam√®tre √† hauteur de poitrine (DBH), sa hauteur (H), le rayon de son houppier (CR), la profondeur de son houppier (CD) et sa surface foliaire (LA). La g√©om√©trie de l'arbre est calcul√©e √† l'aide d'√©quations allom√©triques et la surface foliaire varie dynamiquement au sein de chaque couronne en fonction de l'allocation de carbone. Un arbre peut occuper au maximum un pixel de 1 m sur 1 m. Chaque arbre appartient √† une esp√®ce h√©rit√©e de son arbre parent. Pour chaque esp√®ce, un certain nombre de param√®tres sont connus : les valeurs des traits de cette esp√®ce, qui ont √©t√© recueillies sur le terrain. L'assimilation du carbone est calcul√©e sur une p√©riode de 30 minutes. L'allocation est ensuite calcul√©e pour simuler la croissance des arbres. L'environnement est mis √† jour chaque mois. Les juv√©niles (arbres dont le diam√®tre √† hauteur de poitrine est inf√©rieur √† 1 cm) ne sont pas simul√©s explicitement, mais comme un groupe. En outre, les processus souterrains, les plantes herbac√©es, les √©piphytes et les lianes ne sont pas pris en compte dans TROLL.

## Environnement R

Pendant ce TP, nous utiliserons le mod√®le TROLL [@Marechaux2017] avec le package rcontroll [@schmitt2023]. Nous utiliserons √©galement les packages dplyr, tidyr et ggplot2 pour les manipulations de tables et la cr√©ation de graphiques. T√©l√©chargez-les (pr√©-requis !) :

```{r dl_pkg}
#| eval: false
install.packages("dplyr", "tidyr", "ggplot2", "rcontroll")
```

Chargez les avec :

```{r pkg}
#| message: false
library(dplyr)
library(tidyr)
library(ggplot2)
library(rcontroll)
```

# Donn√©es

## Esp√®ces

Pour fonctionner, le mod√®le TROLL utilise un certain nombre de donn√©es par esp√®ce, dont une liste de traits fonctionnels. Vous pouvez charger les valeurs de ces traits pour un ensemble d'esp√®ces de Guyane fran√ßaise et explorer ces donn√©es.

```{r sp}
data("TROLLv3_species")
```

**Question 1** : Combien de traits sont recens√©s dans ce tableau, et pour combien d'esp√®ce ?

**Question 2** : S√©lectionnez une esp√®ce d'arbre de Guyane fran√ßaise pour ce TP. Quelles sont ses valeurs de traits et que comprenez-vous de ses caract√©ristiques ?

## Esp√®ces

**Question 1** : Combien de traits sont recens√©s dans ce tableau, et pour combien d'esp√®ce ?

```{r sp_dim}
dim(TROLLv3_species)
```

## Esp√®ces {.smaller}

**Question 2** : S√©lectionnez une esp√®ce d'arbre de Guyane fran√ßaise pour ce TP. Quelles sont ses valeurs de traits et que comprenez-vous de ses caract√©ristiques ?

```{r sp_head}
head(TROLLv3_species)
```

::: notes
Esp√®ces dont la dynamique est particuli√®rement int√©ressante : *Cecropia obtusa*, *Vouacapoua americana*
:::

## Climat

Les √©quations qui d√©crivent les processus de la dynamique foresti√®re dans le mod√®le TROLL font intervenir des variables climatiques, ces donn√©es sont r√©unies dans un tableau que vous pouvez charger et explorer :

```{r clim}
data("TROLLv3_climatedaytime12") 
```

**Question 3** : Quelles sont les variables climatiques qui sont utilis√©es pour mod√©liser la dynamique foresti√®re dans TROLL?

**Question 4** : Quelles sont les valeurs moyennes de ces variables en Guyane fran√ßaise? Ces valeurs sont-elles coh√©rentes avec ce que vous savez des conditions d'existence des for√™ts tropicales?

## Climat

**Question 3** : Quelles sont les variables climatiques qui sont utilis√©es pour mod√©liser la dynamique foresti√®re dans TROLL?

```{r clim_head}
head(TROLLv3_climatedaytime12)
```

## Climat {.smaller}

**Question 4** : Quelles sont les valeurs moyennes de ces variables en Guyane fran√ßaise? Ces valeurs sont-elles coh√©rentes avec ce que vous savez des conditions d'existence des for√™ts tropicales?

```{r clim_sum}
summary(TROLLv3_climatedaytime12)
```

## Variation diurne

Dans le mod√®le TROLL, les processus d'assimilation du carbone par les plantes sont calcul√©s sur un pas d'une demi-heure. Les donn√©es climatiques sont donc recalcul√©es sur ce pas de temps, pour cela, vous aurez besoin de charger un troisi√®me tableau, qui correspond aux variances des variables pour chaque pas de temps de la journ√©e :

```{r daily}
data("TROLLv3_daytimevar") 
```

## Param√®tres

Il vous faut maintenant d√©finir les param√®tres de votre simulation :

-   le nombre de pas de temps par an `iterperyear`

-   le nombre de pas de temps total de la simulation `nbiter`

-   la taille de la parcelle simul√©e, grace aux nombres de colonnes `cols` et de lignes `rows` (les parcelles sont rectangulaires)

-   le nombre de graines vennant de l'ext√©rieur `seedrain` (la pluie de graine correspond aux graines qui sont dispers√©e dans la parcelle simul√©e depuis l'exterieur)

## Param√®tres {.smaller}

La fonction `generate_parameters` permet de cr√©er un tableau avec les diff√©rents param√®tres d'une simulation :

```{r generate_parameters}
generate_parameters(cols = 250, rows = 250, nbiter = 12 * 10) %>%
  head() %>%
  knitr::kable()
```

**Question 5** : Si vous utilisez le code pr√©c√©dent, quelle est la dur√©e de votre simulation?

# Simulation

## `troll` {.smaller}

Maintenant que vous avez les donn√©es n√©cessaires, vous pouvez r√©aliser une **simulation**. Pour r√©aliser une simulation, vous pouvez utiliser la fonction `troll()` :

```{r troll}
#| cache: true
#| message: false
#| warning: false
sim <- troll(
  name = "test",
  global = generate_parameters(
    cols = 100, rows = 100,
    iterperyear = 12, nbiter = 12 * 100
  ),
  species = TROLLv3_species,
  climate = TROLLv3_climatedaytime12,
  daily = TROLLv3_daytimevar,
  verbose = TRUE
)
```

**Question 6** : Comment s'appelle votre simulation? Quel est son format (dans R)?

**‚ö†Ô∏è** la fonction `troll()` met un certain temps √† s'ex√©cuter, rappelez-vous que le mod√®le calcule l'assimilation du carbone pour chaque arbre mod√©lis√© sur une p√©riode d'une demi-heure.

## `troll`

**Question 6** : Comment s'appelle votre simulation? Quel est son format (dans R)?

```{r sim_obj}
sim
```

# Visualisation

## `autoplot` {.smaller}

Vous pouvez utiliser la fonction `autoplot()` pour visualiser les r√©sultats de votre simulation, pour cela vous devez choisir les arguments :

-   `what` doit valoir soit `"temporal"`, soit `"spatial"`, soit `"distribution"`
-   `species` doit √™tre le nom de l'esp√®ce √† laquelle vous vous int√©ressez (entre guillemets)

```{r autoplot}
#| eval: false
rcontroll::autoplot(sim,
  what = ,
  species = ) +
  theme(legend.position = "bottom")
```

**Question 7** : Quels sont les indicateurs (ou variables) auxquels vous pouvez avoir acc√®s avec la fonction `autoplot()`?

Vous pouvez constater que la simulation a √©t√© r√©alis√©e √† partir d'un sol nu (sans arbre).

**Question 8** Augmentez le nombre d'ann√©es de simulation et effectuez une simulation de 100 ans. Quelle est la surface terri√®re de cette esp√®ce en d√©but de simulation et en fin de simulation? Comparez vos r√©sultats avec ceux de vos camarades sur les autres esp√®ces.

## `autoplot`

**Question 7** : Quels sont les indicateurs auxquels vous pouvez avoir acc√®s avec la fonction `autoplot()`?

```{r autoplot_sol2}
?rcontroll::`autoplot,trollsim-method`
```

## `autoplot` {.smaller}

**Question 8** : Augmentez le nombre d'ann√©es de simulation et effectuez une simulation de 100 ans. Quelle est la surface terri√®re de cette esp√®ce en d√©but de simulation et en fin de simulation? Comparez vos r√©sultats avec ceux de vos camarades sur les autres esp√®ces.

```{r autoplot_sol3}
rcontroll::autoplot(sim,
  what = "temporal",
  species = "Eperua_grandiflora") +
  theme(legend.position = "bottom")
```

# Multiples simulations

## Pluie de graine

Pour comparer diff√©rentes simulations, il est possible de faire des simulations multiples, dont les jeux de param√®tres peuvent √™tre diff√©rents. Ici, nous allons r√©aliser des simulations en changeant la valeur de la pluie de graine.

**Question 9** : En changeant la pluie de graine, quel(s) processus de la dynamique foresti√®res est/seront impact√©(s) et pourquoi ?

**Question 10** : Comment se disperse l'esp√®ce √©tudi√©e par votre bin√¥me ?

## Param√®tres multiples

Vous pouvez utiliser √† nouveaux la fonction `generate_parameters()`, mais cette fois en pr√©cisans qu'il y aura deux simulations, auxquelles on donnera les noms *seed50000* et *seed500*. Ensuite, vous pouvez changer le param√®tre de la pluie de graine de la simulation *seed500* pour que ce param√®tre soit √©gale √† 500 :

```{r data_stack}
stack_parameters <- generate_parameters( cols = 100, rows = 100, iterperyear = 12, nbiter = 12 * 50 ) %>% 
  mutate(simulation = list(c("seed50000", "seed500"))) %>% 
  unnest(simulation)
stack_parameters[62, 2] <- 500
```

## `stack` {.smaller}

La fonction `stack()` permet des faire des simulations multiples, vous pouvez l'utiliser en pr√©cisant les param√®tres des simulations avec l'argument `global`. Ici l'argument `verbose` prend la valeur `FALSE` pour √©viter d'avoir les messages de TROLL, vous ne verrez donc qu'une barre de chargement pendant les simulations. Les autres arguments de la fonction `stack()` permettent entre autre de pr√©ciser le nombre de coeur utilis√©s (`cores`), et les it√©rations dont les r√©sultats seront stock√©s (`thin`).

```{r stack}
#| cache: true
sim_stack <- stack(
  name = "teststack",
  simulations = c("seed50000", "seed500"),
  global = stack_parameters,
  species = TROLLv3_species,
  climate = TROLLv3_climatedaytime12,
  daily = TROLLv3_daytimevar,
  verbose = FALSE,
  cores = 2,
  thin = (1:10)*10
)
```

## Visualisation multiples {.smaller}

Vous pouvez ensuite utiliser la fonction `autoplot()` comme vous l'avez fait avec une simulation simple :

```{r autoplot_stack}
rcontroll::autoplot(sim_stack,
  what = "temporal",
  variables = c("ba", "agb")
)
```

**Question 12** : Comment se comporte votre esp√®ce? par rapport aux autres? Etait-ce attendu? A votre avis, quel(s) processus est/sont √™tre responsable(s) de ce que vous observez?

# Questions bonus exploratoire

A partir de simulations r√©alis√©es avec le mod√®le TROLL, √† quelle question en √©cologie des for√™ts pouvez-vous r√©pondre ?

# Bonus

Visualisation dynamique

## Code

```{r bonu_code}
#| eval: false
data("TROLLv3_output")

gifs <- autogif(
  name = "dynamic",
  variables = "height_ct",
  global = update_parameters(TROLLv3_output,
    nbiter = 12 * 100,
    extent_visual = 100
  ),
  species = TROLLv3_output@inputs$species,
  climate = TROLLv3_output@inputs$climate,
  daily = TROLLv3_output@inputs$daily,
  forest = get_forest(TROLLv3_output),
  verbose = FALSE
)
gifs$height_ct
```

## Result

```{r bonus_gif}
#| echo: false
knitr::include_graphics("https://raw.githubusercontent.com/sylvainschmitt/rcontroll/main/inst/figures/troll.gif")
```

# Conclusion

F√©licitations üëè , vous √™tes d√©sormais des pros de `rcontroll` !

Plus s√©rieusement, je serais ravis de r√©pondre √† toutes vos questions. N'h√©sitez pas √† consulter [GitHub](https://sylvainschmitt.github.io/rcontroll/) si vous avez besoin d'aide plus tard.

::: footer
*Sylvain Schmitt (sylvain.schmitt\@cirad.fr)*
:::

## R√©f√©rences
