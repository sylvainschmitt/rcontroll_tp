---
title: "Travaux Pratiques `rcontroll`"
subtitle: "Une interface R pour le simulateur de dynamique foresti√®re bas√© sur les individus TROLL"
author: "Sylvain Schmitt"
institute: CIRAD
date: 2025/10/28
date-format: medium
format: 
  revealjs:
    theme: dark
    output-location: fragment
    slide-number: true
    logo: figs/logo_ucl.png
    transition: fade
    preview-links: true
    chalkboard: true
bibliography: references.bib
include-in-header:
  - text: |
      <style>
      .reveal .slide-logo {
        max-height: unset;
        height: 100px;
      }
      </style>
---


```{r set}
#| include: false
library(dplyr)
library(tidyr)
library(ggplot2)
library(rcontroll)
knitr::opts_chunk$set(echo = TRUE)
set.seed(42)
```

# Introduction

## Packages 

Pendant ce TP, nous allons utiliser le mod√®le TROLL [@Marechaux2017], avec le package `rcontroll` [@schmitt2023].
Nous utiliserons aussi les package `dplyr` [@dplyr], `tidyr` [@tidyr] et `ggplot2` [@ggplot2].

Pour t√©l√©charger les packages : 

```{r dl_pkg}
#| eval: false
install.packages("dplyr", "tidyr", "ggplot2", "rcontroll")
```

Ensuite, vous pouvez charger les packages : 

```{r pkg}
#| message: false
library(dplyr)
library(tidyr)
library(ggplot2)
library(rcontroll)
```

## TROLL {.smaller}

TROLL mod√©lise chaque arbre individuellement dans un environnement spatialis√©. Le mod√®le TROLL peut donc √™tre d√©fini comme un mod√®le de croissance foresti√®re *individu centr√©* et *spatialement explicite*. TROLL simule le cycle de vie des arbres depuis le recrutement √† partir d'un diam√®tre √† hauteur de poitrine (dbh) de 1cm, jusqu'√† la mort. Les arbres poussent dans un environnement lumineux, les valeurs de lumi√®re sont calcul√©es dans des *voxels* de 1m3.

```{r troll_fig}
#| echo: false
knitr::include_graphics("https://gmd.copernicus.org/articles/18/5143/2025/gmd-18-5143-2025-avatar-web.png")
```

## TROLL {.smaller}

Chaque arbre est d√©fini par son √¢ge, son diam√®tre √† hauteur de poitrine (*dbh*), sa hauteur (*h*), le rayon de son houppier (*CR*), la profondeur de son houppier (*CD*) et sa surface foliaire (*LA*). La g√©om√©trie de l'arbre est calcul√©e √† l'aide d'*√©quations allom√©triques*, et la surface foliaire varie dynamiquement au sein de chaque couronne en fonction des allocations de carbone. Au maximum un arbre peut s'installer dans chaque pixel de 1x1m. Chaque arbre appartient √† une esp√®ce, h√©rit√©e de son arbre parent. Pour chaque esp√®ce, un certain nombre de param√®tres sont connus : les valeurs de traits de cette esp√®ces, qui ont √©t√© r√©colt√©s sur le terrain. L'assimilation du carbone est calcul√©e sur une p√©riode d'une demi-heure. L'allocation est ensuite calcul√©e pour simuler la croissance des arbres. L'environnement est mis √† jour chaque mois. Les juv√©niles (arbres dont le dbh < 1cm) ne sont pas simul√©s explicitement mais comme un groupe. En outre, les processus souterrains, les plantes herbac√©es, les √©piphytes et les lianes ne sont pas simul√©s dans TROLL.

# Donn√©es

## Esp√®ces

Pour fonctionner, le mod√®le TROLL utilise une liste de traits fonctionnels. Vous pouvez charger les valeurs de trait pour un ensemble d'esp√®ces de Guyane fran√ßaise, et explorer ces donn√©es :

```{r sp}
data("TROLLv3_species")
```

**Question 1** : Combien de traits sont recens√©s dans ce tableau, et pour combien d'esp√®ce?

**Question 2** : Quelles sont les esp√®ces d'arbre de Guyane fran√ßaise que vous connaissez? Les valeurs de trait sont-elles pr√©sentes dans la table pour ces esp√®ces?

## Esp√®ces

**Question 1** : Combien de traits sont recens√©s dans ce tableau, et pour combien d'esp√®ce?

```{r sp_dim}
dim(TROLLv3_species)
```

## Esp√®ces {.smaller}

**Question 2** : Quelles sont les esp√®ces d'arbre de Guyane fran√ßaise que vous connaissez? Les valeurs de trait sont-elles pr√©sentes dans la table pour ces esp√®ces?

```{r sp_head}
head(TROLLv3_species)
```

::: notes
Esp√®ces dont la dynamique est particuli√®rement int√©ressante : *Cecropia obtusa*, *Vouacapoua americana*
:::

## Climat

Les √©quations qui d√©crivent les processus de la dynamique foresti√®re dans le mod√®le TROLL font intervenir des variables climatiques, ces donn√©es sont r√©unies dans un tableau que vous pouvez charger et explorer :

```{r clim}
data("TROLLv3_climatedaytime12") 
```

**Question 3** : Quelles sont les variables climatiques qui sont utilis√©es pour mod√©liser la dynamique foresti√®re dans TROLL?

**Question 4** : Quelles sont les valeurs moyennes de ces variables en Guyane fran√ßaise? Ces valeurs sont-elles coh√©rentes avec ce que vous savez des conditions d'existence des for√™ts tropicales?

## Climat

**Question 3** : Quelles sont les variables climatiques qui sont utilis√©es pour mod√©liser la dynamique foresti√®re dans TROLL?

```{r clim_head}
head(TROLLv3_climatedaytime12)
```

## Climat {.smaller}

**Question 4** : Quelles sont les valeurs moyennes de ces variables en Guyane fran√ßaise? Ces valeurs sont-elles coh√©rentes avec ce que vous savez des conditions d'existence des for√™ts tropicales?

```{r clim_sum}
summary(TROLLv3_climatedaytime12)
```

## Variation diurne

Dans le mod√®le TROLL, les processus d'assimilation du carbone par les plantes sont calcul√©s sur un pas d'une demi-heure. Les donn√©es climatiques sont donc recalcul√©es sur ce pas de temps, pour cela, vous aurez besoin de charger un troisi√®me tableau, qui correspond aux variances des variables pour chaque pas de temps de la journ√©e :

```{r daily}
data("TROLLv3_daytimevar") 
```

## Param√®tres

Il vous faut maintenant d√©finir les param√®tres de votre simulation :

- le nombre de pas de temps par an `iterperyear`

- le nombre de pas de temps total de la simulation `nbiter`

- la taille de la parcelle simul√©e, grace aux nombres de colonnes `cols` et de lignes `rows`

- le nombre de graines vennant de l'ext√©rieur `seedrain`

## Param√®tres {.smaller}

La fonction `generate_parameters` permet de cr√©er un tableau avec les diff√©rents param√®tres d'une simulation : 

```{r generate_parameters}
generate_parameters(cols = 250, rows = 250, nbiter = 12 * 1) %>%
  head() %>%
  knitr::kable()
```

**Question 5** : Si vous utilisez le code pr√©c√©dent, quelle est la dur√©e de votre simulation?

# Simulation

## `troll`

Maintenant que vous avez les donn√©es n√©cessaires, vous pouvez r√©aliser une **simulation**.
Pour r√©aliser une simulation, vous pouvez utiliser la fonction `troll()` :

```{r troll}
#| cache: true
#| message: false
#| warning: false
sim <- troll(
  name = "test",
  global = generate_parameters(
    cols = 100, rows = 100,
    iterperyear = 12, nbiter = 12 * 1
  ),
  species = TROLLv3_species,
  climate = TROLLv3_climatedaytime12,
  daily = TROLLv3_daytimevar,
  verbose = TRUE
)
```

**Question 6** : Comment s'appelle votre simulation? Quel est son format (dans R)?

## `troll`

**Question 6** : Comment s'appelle votre simulation? Quel est son format (dans R)?

```{r sim_obj}
sim
```

# Visualisation

## `autoplot` {.smaller}

Vous pouvez utiliser la fonction `autoplot()` pour visualiser les r√©sultats de votre simulation, pour cela vous devez choisir les arguments :

- `what` doit valoir soit `"temporal"`, soit `"spatial"`, soit `"distribution"`
- `species` doit √™tre le nom de l'esp√®ce √† laquelle vous vous int√©ressez (entre guillemets)

```{r autoplot}
#| eval: false
rcontroll::autoplot(sim,
  what = ,
  species = ) +
  theme(legend.position = "bottom")
```

**Question 7** : Par bin√¥me, choisissez une esp√®ce, et remplissez le tableau avec votre num√©ro de bin√¥me et le nom de l'esp√®ce que vous avez choisie.

**Question 8** : Quels sont les indicateurs auxquels vous pouvez avoir acc√®s avec la fonction `autoplot()`?

**Question 9** : Quelle est la surface terri√®re de cette esp√®ce en d√©but de simulation/ en fin de simulation? Comparez vos r√©sultats avec ceux de vos camarades sur les autres esp√®ces.

## `autoplot` {.smaller}

**Question 7** : Par bin√¥me, choisissez une esp√®ce, et remplissez le tableau avec votre num√©ro de bin√¥me et le nom de l'esp√®ce que vous avez choisie.

```{r autoplot_sol}
rcontroll::autoplot(sim,
  what = "temporal",
  species = "Eperua_grandiflora") +
  theme(legend.position = "bottom")
```

## `autoplot`

**Question 8** : Quels sont les indicateurs auxquels vous pouvez avoir acc√®s avec la fonction `autoplot()`?

```{r autoplot_sol2}
?rcontroll::`autoplot,trollsim-method`
```

## `autoplot` {.smaller}

**Question 9** : Quelle est la surface terri√®re de cette esp√®ce en d√©but de simulation/ en fin de simulation? Comparez vos r√©sultats avec ceux de vos camarades sur les autres esp√®ces.

```{r autoplot_sol3}
rcontroll::autoplot(sim,
  what = "temporal",
  species = "Eperua_grandiflora") +
  theme(legend.position = "bottom")
```

# Multiples simulations

## Pluie de graine

Pour comparer diff√©rentes simulations, il est possible de faire des simulations multiples, dont les jeux de param√®tres peuvent √™tre diff√©rents. Ici, nous allons r√©aliser des simulations en changeant la valeur de la pluie de graine.

**Question 10** : En changeant la pluie de graine, quel(s) processus de la dynamique foresti√®res est/seront impact√©(s) et pourquoi ?

**Question 11** : Comment se disperse l'esp√®ce √©tudi√©e par votre bin√¥me ?

## Param√®tres multiples

Vous pouvez utiliser √† nouveaux la fonction `generate_parameters()`, mais cette fois en pr√©cisans qu'il y aura deux simulations, auxquelles on donnera les noms *seed50000* et *seed500*. Ensuite, vous pouvez changer le param√®tre de la pluie de graine de la simulation *seed500* pour que ce param√®tre soit √©gale √† 500 :

```{r data_stack}
stack_parameters <- generate_parameters( cols = 100, rows = 100, iterperyear = 12, nbiter = 12 * 1 ) %>% 
  mutate(simulation = list(c("seed50000", "seed500"))) %>% 
  unnest(simulation)
stack_parameters[62, 2] <- 500
```

## `stack` {.smaller}

La fonction `stack()` permet des faire des simulations multiples, vous pouvez l'utiliser en pr√©cisant les param√®tres des simulations avec l'argument `global`. Ici l'argument `verbose` prend la valeur `FALSE` pour √©viter d'avoir les messages de TROLL, vous ne verrez donc qu'une barre de chargement pendant les simulations.
Les autres arguments de la fonction `stack()` permettent entre autre de pr√©ciser le nombre de coeur utilis√©s (`cores`), et les it√©rations dont les r√©sultats seront stock√©s (`thin`).

```{r stack}
#| cache: true
sim_stack <- stack(
  name = "teststack",
  simulations = c("seed50000", "seed500"),
  global = stack_parameters,
  species = TROLLv3_species,
  climate = TROLLv3_climatedaytime12,
  daily = TROLLv3_daytimevar,
  verbose = FALSE,
  cores = 2,
  thin = c(1, 5, 10)
)
```

## Visualisation multiples {.smaller}

Vous pouvez ensuite utiliser la fonction `autoplot()` comme vous l'avez fait avec une simulation simple : 

```{r autoplot_stack}
rcontroll::autoplot(sim_stack,
  what = "temporal",
  variables = c("ba", "agb")
)
```

**Question 13** : Comment se comporte votre esp√®ce? par rapport aux autres? Etait-ce attendu? A votre avis, quel(s) processus est/sont √™tre responsable(s) de ce que vous observez?

# Questions bonus exploratoire

A partir de simulations r√©alis√©es avec le mod√®le TROLL, √† quelle question en √©cologie des for√™ts pouvez-vous r√©pondre ?

# Bonus

Visualisation dynamique

## Code

```{r bonu_code}
#| eval: false
data("TROLLv3_output")

gifs <- autogif(
  name = "dynamic",
  variables = "height_ct",
  global = update_parameters(TROLLv3_output,
    nbiter = 12 * 100,
    extent_visual = 100
  ),
  species = TROLLv3_output@inputs$species,
  climate = TROLLv3_output@inputs$climate,
  daily = TROLLv3_output@inputs$daily,
  forest = get_forest(TROLLv3_output),
  verbose = FALSE
)
gifs$height_ct
```

## Result

```{r bonus_gif}
#| echo: false
knitr::include_graphics("https://raw.githubusercontent.com/sylvainschmitt/rcontroll/main/inst/figures/troll.gif")
```

# Conclusion

F√©licitations üëè , vous √™tes d√©sormais des pros de `rcontroll` !

Plus s√©rieusement, je serais ravis de r√©pondre √† toutes vos questions. N'h√©sitez pas √† consulter [GitHub](https://sylvainschmitt.github.io/rcontroll/) si vous avez besoin d'aide plus tard.

::: footer
*Sylvain Schmitt (sylvain.schmitt\@cirad.fr)*
:::

## R√©f√©rences
